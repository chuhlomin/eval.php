<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <link rel="shortcut icon" href="/favicon.ico">

    <title>Eval</title>

    <!-- Bootstrap core CSS -->
    <link href="/js/libs/bootstrap-3.1.1-dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/js/libs/codemirror-4.0/lib/codemirror.css">

    <link rel="stylesheet" href="/css/custom.css">
</head>

<body>

<!-- Fixed navbar -->
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <a class="navbar-brand" href="#">Eval</a>
            <form class="nav navbar-form navbar-left" id="codeID">
                <div id="loader"></div>
                <input type="text" value="" class="form-control">

            </form>
        </div>
        <nav>
            <form class="nav navbar-form navbar-right">
                {% if isSaveAvailable is defined %}
                    {%  if isSaveAvailable %}
                        <div class="button-with-hotkey">
                            <button type="submit" class="btn btn-outline-inverse" onclick="saveForm(); return false;">Save</button>
                            <div class="button-hotkey" data-os="mac">⌘ + S</div>
                            <div class="button-hotkey" data-os="windows">Ctrl + S</div>
                        </div>
                    {% else %}
                        <div class="button-with-hotkey">
                            <button type="button" class="btn btn-outline-inverse disabled" data-toggle="tooltip" data-placement="bottom" title="Unavailable to save">Save</button>
                        </div>
                    {% endif %}
                {% endif %}
                <div class="button-with-hotkey">
                    <button type="submit" class="btn btn-primary" onclick="sendForm(); return false;">Eval</button>
                    <div class="button-hotkey" data-os="mac">⌘ + Enter</div>
                    <div class="button-hotkey" data-os="windows">Ctrl + Enter</div>
                </div>
            </form>
        </nav>
    </div>
</div>

{% block content %}
{% endblock %}

<!-- Bootstrap core JavaScript
    ================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="/js/libs/bootstrap-3.1.1-dist/js/bootstrap.min.js"></script>
<script src="/js/libs/KeyboardJS-0.4.2/keyboard.js"></script>
<script src="/js/jquery.client.js"></script>

<script src="/js/libs/codemirror-4.0/lib/codemirror.js"></script>
<script src="/js/libs/codemirror-4.0/mode/htmlmixed/htmlmixed.js"></script>
<script src="/js/libs/codemirror-4.0/mode/xml/xml.js"></script>
<script src="/js/libs/codemirror-4.0/mode/javascript/javascript.js"></script>
<script src="/js/libs/codemirror-4.0/mode/css/css.js"></script>
<script src="/js/libs/codemirror-4.0/mode/clike/clike.js"></script>
<script src="/js/libs/codemirror-4.0/mode/php/php.js"></script>
{#<script src="/js/libs/codemirror/util/formatting.js"></script>#}
{#<script src="/js/libs/codemirror/util/foldcode.js"></script>#}
{#<script src="/js/libs/codemirror/util/searchcursor.js"></script>#}
{#<script src="/js/libs/codemirror/util/match-highlighter.js"></script>#}
{#<script src="/js/libs/codemirror/xml/xml.js"></script>#}
{#<script src="/js/libs/codemirror/css/css.js"></script>#}
{#<script src="/js/libs/codemirror/clike/clike.js"></script>#}

<script>
    var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
        lineNumbers: true,
        matchBrackets: true,
        mode: "application/x-httpd-php",
        indentUnit: 4,
        indentWithTabs: true,
        enterMode: "keep",
        tabMode: "shift"
    });

    var sendForm = function() {
        editor.save();

        var timeStart = new Date().getTime();

        $.ajax(
            '/eval',
            {
                type: 'post',
                dataType: 'json',
                data: {
                    'code': $('#code').val()
                },
                beforeSend: function () {
                    $('#loader').fadeIn();
                    $('#result').addClass('text-muted');


                },
                complete: function (jqXHR, textStatus) {
                    var timeDiff = new Date().getTime() - timeStart;

                    setTimeout(function() {
                        $('#loader').fadeOut();

                        if (textStatus == 'success') {
                        }
                        $('#result')
                                .html(jqXHR.responseJSON.output)
                                .removeClass('text-muted');

                        $('.output').fadeIn();
                    }, 500 - timeDiff);
                }
            }
        );
    };

    var saveForm = function() {
        editor.save();

        var timeStart = new Date().getTime();

        $.ajax(
            '/save',
            {
                type: 'post',
                dataType: 'json',
                data: {
                    'code': $('#code').val()
                },
                beforeSend: function () {
                    $('#loader').fadeIn();
                },
                complete: function (jqXHR, textStatus) {
                    var timeDiff = new Date().getTime() - timeStart;

                    setTimeout(function() {
                        $('#loader').fadeOut();

                        if (textStatus == 'success') {
                            var id = jqXHR.responseJSON.result;
                            $('#codeID .form-control').val(id);
                            document.location.href = '?#' + id;
                        }
                    }, 500 - timeDiff);
                }
            }
        );
    };

    var os = $.client.os.toLowerCase();
    $('body').attr('data-os', os);

    console.log(os);

    if (os == 'mac') {
        KeyboardJS.on('command + enter', function() { sendForm(); });
        KeyboardJS.on('command + s', function() { saveForm(); return false; });

        $('.button-hotkey[data-os="windows"]').hide();
        $('.button-hotkey[data-os="mac"]').show();
    }
    else if (os == 'windows' || os == 'linux') {
        KeyboardJS.on('ctrl + enter', function() { sendForm(); });
        KeyboardJS.on('ctrl + s', function() { saveForm(); return false; });
    }

    $('[data-toggle=tooltip]').tooltip();

</script>

<script type="text/javascript" src="/js/canvas.js"></script>
<script type="text/javascript">
    var cSpeed=9;
    var cWidth=20;
    var cHeight=20;
    var cTotalFrames=12;
    var cFrameWidth=20;
    var cImageSrc='/images/sprites.png';

    var cImageTimeout=false;

    function startAnimation(){

        document.getElementById('loader').innerHTML='<canvas id="canvas" width="'+cWidth+'" height="'+cHeight+'"><p>Your browser does not support the canvas element.</p></canvas>';

        FPS = Math.round(100/cSpeed);
        SECONDS_BETWEEN_FRAMES = 1 / FPS;
        g_GameObjectManager = null;
        g_run=genImage;

        g_run.width=cTotalFrames*cFrameWidth;
        genImage.onload=function (){cImageTimeout=setTimeout(fun, 0)};
        initCanvas();
    }


    function imageLoader(s, fun)//Pre-loads the sprites image
    {
        clearTimeout(cImageTimeout);
        cImageTimeout=0;
        genImage = new Image();
        genImage.onload=function (){cImageTimeout=setTimeout(fun, 0)};
        genImage.onerror=new Function('alert(\'Could not load the image\')');
        genImage.src=s;
    }

    //The following code starts the animation
    new imageLoader(cImageSrc, 'startAnimation()');
</script>

</body>
</html>
